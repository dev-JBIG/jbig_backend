name: Django deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add deploy host to known_hosts
        run: ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Upload with rsync (no scp action)
        run: |
          set -euo pipefail
          # rsync 설치 (GitHub ubuntu 러너엔 보통 없어서 설치)
          sudo apt-get update
          sudo apt-get install -y rsync

          # 원격 경로 준비
          ssh -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            "mkdir -p '${{ secrets.DEPLOY_PATH }}'"

          # 제외 규칙 적용해서 동기화
          rsync -az --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='node_modules/' \
            --exclude='venv/' \
            --exclude='.venv/' \
            --exclude='**/__pycache__/' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            --exclude='**/*.pyc' \
            --exclude='**/.pytest_cache/' \
            --exclude='.env' \
            ./ \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:'${{ secrets.DEPLOY_PATH }}/'"

      - name: Restart runserver (no systemd)
        run: |
          set -euo pipefail
          ssh "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" bash -lc "
            cd '${{ secrets.DEPLOY_PATH }}'

            # .venv 준비
            if [ ! -d '.venv' ]; then
              python3 -m venv .venv
            fi
            . .venv/bin/activate

            # 필요 시 주석 해제
            # pip install --upgrade pip
            # pip install -r requirements.txt

            # 기존 runserver 종료(있으면)
            pkill -f 'manage.py runserver 0.0.0.0:3001' || true
            sleep 1

            # 백그라운드 실행
            nohup python3 manage.py runserver 0.0.0.0:3001 > runserver.out 2>&1 &
