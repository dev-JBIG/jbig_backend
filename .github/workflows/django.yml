name: Django Deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt

      - name: Build static files and run tests
        run: |
          source .venv/bin/activate
          python manage.py collectstatic --noinput
          #python manage.py test

      - name: Create build archive
        run: |
          tar czf /tmp/build.tar.gz \
            --exclude='.venv' \
            --exclude='.git' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            .
          mv /tmp/build.tar.gz build.tar.gz

      - name: Upload build to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "build.tar.gz"
          target: $HOME/releases/

      - name: Deploy new release on server
        uses: appleboy/ssh-action@master
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            APP_DIR="$HOME/${{ secrets.DEPLOY_PATH }}/current"
            RELEASES_DIR="$HOME/releases"
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            NEW_RELEASE="$RELEASES_DIR/$TIMESTAMP"

            mkdir -p "$NEW_RELEASE"
            tar xzf "$RELEASES_DIR/build.tar.gz" -C "$NEW_RELEASE"

            cd "$NEW_RELEASE"
            [ -d .venv ] || python3 -m venv .venv
            . .venv/bin/activate
            pip install -r requirements.txt --no-cache-dir

            python manage.py migrate --noinput
            python manage.py collectstatic --noinput

            ln -sfn "$NEW_RELEASE" "$APP_DIR"

            cd "$APP_DIR"
            GUNICORN_PID=$(pgrep -f "gunicorn .*wsgi:application" || true)
            if [ -n "$GUNICORN_PID" ]; then
              kill -HUP "$GUNICORN_PID" || true
              sleep 3
            else
              .venv/bin/gunicorn jbig_backend.wsgi:application \
                --bind 0.0.0.0:3001 --workers 3 --timeout 60 \
                --daemon \
                --pid /tmp/gunicorn.pid
            fi
           
            sudo systemctl reload nginx

            echo "Deployed new version: $TIMESTAMP"
