name: Django deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add deploy host to known_hosts
        run: ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Copy project to server (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: |
            ./**
            !.git/**
            !.github/**
            !**/node_modules/**
            !**/venv/**
            !**/.venv/**
            !**/__pycache__/**
            !**/*.log
            !**/.env
          target: ${{ secrets.DEPLOY_PATH }}
          overwrite: true

      - name: Restart runserver (no systemd)
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            cd "$DEPLOY_PATH"

            # .venv 준비
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi
            . .venv/bin/activate

            # 필요 시 의존성 (원하면 주석 해제)
            # pip install --upgrade pip
            # pip install -r requirements.txt

            # 기존 runserver 종료
            pkill -f "manage.py runserver 0.0.0.0:3001" || true
            sleep 1

            # 백그라운드 실행
            nohup python3 manage.py runserver 0.0.0.0:3001 > runserver.out 2>&1 &
