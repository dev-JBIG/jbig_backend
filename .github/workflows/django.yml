name: Django Deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 서버 접속용 SSH 에이전트 준비 (서버로 SSH 접속하는 용도)
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add deploy host to known_hosts
        run: ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      # 서버에서 git pull 하고 gunicorn 재가동
      - name: Update code on server and restart
        run: |
          set -x
          ssh "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}"
            set -x
            REPO_SSH="git@github.com:${{ github.repository }}.git"
            APP_DIR="$HOME/${{ secrets.DEPLOY_PATH }}"
            
            # 0) 디렉터리 준비
            mkdir -p "$APP_DIR"
            # 1) 레포 없으면 clone, 있으면 최신화
            if [ ! -d "$APP_DIR/.git" ]; then
              git clone "$REPO_SSH" "$APP_DIR"
            fi

            cd "$APP_DIR"

            # ★추가: origin을 SSH로 강제(https 잔재 제거)
            git remote set-url origin "$REPO_SSH"

            # 안전하게 원격 기준으로 맞춤
            git fetch origin
            git checkout main
            git reset --hard origin/main

            # 2) 가상환경(.venv) 준비
            [ -d .venv ] || python3 -m venv .venv
            . .venv/bin/activate

            # (필요 시 주석 해제)
            # pip install --upgrade pip
            pip install -r requirements.txt
            python3 manage.py migrate --noinput
            python3 manage.py collectstatic --noinput

            # 3) gunicorn으로 재가동 (systemd 미사용 시)
            pkill -f "gunicorn .*jbig_backend\.wsgi:application" || true
            sleep 1
            . .venv/bin/activate
            nohup gunicorn jbig_backend.wsgi:application \
              --bind 0.0.0.0:3001 --workers 3 --timeout 60 \
              > gunicorn.out 2>&1 &

            # 4) 간단 체크
            sleep 2
            if pgrep -f "gunicorn .*jbig_backend\.wsgi:application" >/dev/null; then 
              echo "Gunicorn up on :3001"
            else
              echo "Gunicorn not found"
            fi

      - name: Deploy static files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ./staticfiles/
          target: ${{ secrets.DEPLOY_PATH }}

      - name: Check build directory
        run: |
          echo "Files in ./build:"
          ls -al ./build

      - name: Copy project to deploy server (SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: ./build/
          target: ${{ secrets.DEPLOY_PATH }}
          overwrite: true
          debug: true

      - name: Restart service on deploy server
        uses: appleboy/ssh-action@master
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          SYSTEMD_SERVICE: ${{ secrets.SYSTEMD_SERVICE }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            rsync -a --delete "$DEPLOY_PATH/release/" "$DEPLOY_PATH/current/"
            sudo systemctl daemon-reload || true
            sudo systemctl restart "$SYSTEMD_SERVICE"
            sudo systemctl is-active "$SYSTEMD_SERVICE"
